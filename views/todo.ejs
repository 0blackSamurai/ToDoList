<%- include('./partials/header') %>

<div class="date-navigation">
    <a href="/<%= prevDate %>" class="btn btn-small" aria-label="Previous day">
        <i class="fas fa-chevron-left"></i> Previous Day
    </a>
    
    <h1><%= title %></h1>
    
    <a href="/<%= nextDate %>" class="btn btn-small" aria-label="Next day">
        Next Day <i class="fas fa-chevron-right"></i>
    </a>
</div>

<form class="todo-form" action="/todo" method="POST">
    <h2>Add New Todo</h2>
    
    <div class="form-group">
        <label for="title">Title</label>
        <input type="text" id="title" name="title" required aria-label="Todo title">
    </div>
    
    <div class="form-group">
        <label for="description">Description (Optional)</label>
        <textarea id="description" name="description" aria-label="Todo description"></textarea>
    </div>
    
    <div class="form-group">
        <label for="date">Date</label>
        <input type="date" id="date" name="date" value="<%= currentDate %>" required aria-label="Todo date">
    </div>
    
    <button type="submit" class="btn">Add Todo</button>
</form>

<h2>Your Todos for <%= isToday ? 'Today' : currentDate %></h2>

<% if (todos.length === 0) { %>
    <p>No todos for this day. Add a new todo above!</p>
<% } else { %>
    <ul class="todo-list">
        <% todos.forEach(todo => { %>
            <li class="todo-item <%= todo.completed ? 'completed' : '' %>" data-id="<%= todo._id %>">
                <div class="todo-text">
                    <h3 class="todo-title"><%= todo.title %></h3>
                    <% if (todo.description) { %>
                        <p class="todo-description"><%= todo.description %></p>
                    <% } %>
                </div>
                
                <div class="todo-actions">
                    <button type="button" class="toggle-status" aria-label="<%= todo.completed ? 'Mark as incomplete' : 'Mark as complete' %>">
                        <i class="fas <%= todo.completed ? 'fa-undo' : 'fa-check' %>"></i>
                    </button>
                    
                    <button type="button" class="delete-todo" aria-label="Delete todo">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </li>
        <% }) %>
    </ul>
<% } %>

<% 
// Add custom scripts for this page
const scriptContent = `
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle todo status
        const toggleButtons = document.querySelectorAll('.toggle-status');
        toggleButtons.forEach(button => {
            button.addEventListener('click', async function() {
                const todoItem = this.closest('.todo-item');
                const todoId = todoItem.dataset.id;
                
                try {
                    const response = await fetch('/todo/' + todoId, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Toggle class on todo item
                        todoItem.classList.toggle('completed');
                        
                        // Update icon
                        const icon = this.querySelector('i');
                        if (result.completed) {
                            icon.className = 'fas fa-undo';
                            this.setAttribute('aria-label', 'Mark as incomplete');
                        } else {
                            icon.className = 'fas fa-check';
                            this.setAttribute('aria-label', 'Mark as complete');
                        }
                    }
                } catch (error) {
                    console.error('Error toggling todo status:', error);
                }
            });
        });
        
        // Delete todo
        const deleteButtons = document.querySelectorAll('.delete-todo');
        deleteButtons.forEach(button => {
            button.addEventListener('click', async function() {
                if (!confirm('Are you sure you want to delete this todo?')) {
                    return;
                }
                
                const todoItem = this.closest('.todo-item');
                const todoId = todoItem.dataset.id;
                
                try {
                    const response = await fetch('/todo/' + todoId, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Remove the todo item from the DOM
                        todoItem.remove();
                        
                        // If no todos left, show message
                        const todoList = document.querySelector('.todo-list');
                        if (todoList.children.length === 0) {
                            const noTodosMessage = document.createElement('p');
                            noTodosMessage.textContent = 'No todos for this day. Add a new todo above!';
                            todoList.parentNode.replaceChild(noTodosMessage, todoList);
                        }
                    }
                } catch (error) {
                    console.error('Error deleting todo:', error);
                }
            });
        });
    });
</script>
`;
%>

<%- include('./partials/footer', { scripts: scriptContent }) %>